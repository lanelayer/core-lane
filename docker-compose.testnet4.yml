services:
  bitcoin-cache-testnet4:
    image: ghcr.io/lanelayer/core-lane/core-lane:latest
    container_name: bitcoin-cache-testnet4
    restart: unless-stopped
    ports:
      - "18332:8332"
    command: >
      /app/core-lane-node bitcoin-cache
      --host 0.0.0.0
      --port 8332
      --cache-dir /cache
      --bitcoin-rpc-url https://core-lane-cache-testnet4.fly.dev
      --starting-block-count ${TESTNET4_STARTING_BLOCK:-111303}
      --no-rpc-auth
    volumes:
      - bitcoin-cache-testnet4:/cache
    networks:
      - lane-network-testnet4

  core-lane-testnet4:
    image: ghcr.io/lanelayer/core-lane/core-lane:latest
    container_name: core-lane-testnet4
    depends_on:
      - bitcoin-cache-testnet4
    ports:
      - "8546:8545"
    environment:
      - CORE_LANE_MNEMONIC=${CORE_LANE_MNEMONIC}
      - NETWORK=${NETWORK:-testnet4}
      - ELECTRUM_URL=${ELECTRUM_URL:-ssl://mempool.space:40002}
    command: >
      sh -c "
      /app/core-lane-node start
      --data-dir /data
      --bitcoin-rpc-read-url http://bitcoin-cache-testnet4:8332
      --bitcoin-rpc-read-user ${RPC_USER:-bitcoin}
      --bitcoin-rpc-read-password ${RPC_PASSWORD:-bitcoin123}
      --bitcoin-rpc-write-url http://bitcoin-cache-testnet4:8332
      --bitcoin-rpc-write-user ${RPC_USER:-bitcoin}
      --bitcoin-rpc-write-password ${RPC_PASSWORD:-bitcoin123}
      --start-block ${TESTNET4_STARTING_BLOCK:-4782948}
      --mnemonic \"$$CORE_LANE_MNEMONIC\"
      --electrum-url \"$$ELECTRUM_URL\"
      --http-host 0.0.0.0
      --http-port 8545
      "
    volumes:
      - core-lane-testnet4:/data
    restart: unless-stopped
    networks:
      - lane-network-testnet4

networks:
  lane-network-testnet4:
    driver: bridge

volumes:
  bitcoin-cache-testnet4:
  core-lane-testnet4:


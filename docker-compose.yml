services:
  bitcoin-cache:
    image: ghcr.io/lanelayer/core-lane/core-lane:latest
    container_name: bitcoin-cache
    restart: unless-stopped
    ports:
      - "8332:8332"   # Bitcoin Cache RPC
    environment:
      - BITCOIN_UPSTREAM_RPC_URL=https://bitcoin-signet.g.alchemy.com/v2/${ALCHEMY_SIGNET_API_KEY}
      - STARTING_BLOCK_COUNT=278860
    volumes:
      - bitcoin-cache:/cache
    networks:
      - lane-network

  core-lane:
    image: ghcr.io/lanelayer/core-lane/core-lane:latest
    container_name: core-lane
    depends_on:
      - bitcoin-cache
    ports:
      - "8545:8545"   # Core Lane RPC
    environment:
      - CORE_LANE_MNEMONIC=${CORE_LANE_MNEMONIC}
      - NETWORK=${NETWORK:-signet}
      - ELECTRUM_URL=${ELECTRUM_URL:-ssl://electrum.blockstream.info:60602}
    command: >
      sh -c "
      /app/core-lane-node start
      --data-dir /data
      --bitcoin-rpc-read-url http://bitcoin-cache:8332
      --bitcoin-rpc-read-user ${RPC_USER:-bitcoin}
      --bitcoin-rpc-read-password ${RPC_PASSWORD:-bitcoin123}
      --bitcoin-rpc-write-url http://bitcoin-cache:8332
      --bitcoin-rpc-write-user ${RPC_USER:-bitcoin}
      --bitcoin-rpc-write-password ${RPC_PASSWORD:-bitcoin123}
      --start-block 278860
      --mnemonic \"$$CORE_LANE_MNEMONIC\"
      --electrum-url \"$$ELECTRUM_URL\"
      --http-host 0.0.0.0
      --http-port 8545
      "
    volumes:
      - core-lane:/data  # Persist wallet database and state
    restart: unless-stopped
    networks:
      - lane-network

networks:
  lane-network:
    driver: bridge

volumes:
  # bitcoind:
  bitcoin-cache:
  core-lane:  # Stores wallet databases (wallet_<network>.sqlite3) and state